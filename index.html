<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Content Planner</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function InstagramPlanner() {
            const [posts, setPosts] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [notionToken, setNotionToken] = useState('');
            const [databaseId, setDatabaseId] = useState('');
            const [isConfigured, setIsConfigured] = useState(false);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const token = params.get('token');
                const dbId = params.get('database');

                if (token && dbId) {
                    setNotionToken(token);
                    setDatabaseId(dbId);
                    fetchPostsWithParams(token, dbId);
                }
            }, []);

            const fetchPostsWithParams = async (token, dbId) => {
                setLoading(true);
                setError('');

                try {
                    const response = await fetch('/api/notion', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: token, databaseId: dbId })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to fetch from Notion');
                    }

                    const data = await response.json();

                    const formattedPosts = data.results.map(page => {
                        const name = page.properties.Name?.title?.[0]?.plain_text || 'Untitled';
                        const publishDate = page.properties['Publish Date']?.date?.start || null;
                        const attachment = page.properties.Attachment?.files?.[0];
                        let imageUrl = null;
                        if (attachment) imageUrl = attachment.file?.url || attachment.external?.url || null;
                        return { id: page.id, name, publishDate, imageUrl };
                    });

                    const sortedPosts = formattedPosts.sort((a, b) => new Date(b.publishDate) - new Date(a.publishDate));

                    setPosts(sortedPosts);
                    setIsConfigured(true);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const fetchPosts = async () => {
                if (!notionToken || !databaseId) return;
                await fetchPostsWithParams(notionToken, databaseId);
            };

            const formatDate = (dateString) => {
                if (!dateString) return 'No date';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            };

            if (!isConfigured) {
                return (
                    <div className="min-h-screen bg-neutral-50 flex items-center justify-center p-6">
                        <div className="bg-white rounded-2xl shadow-md w-full max-w-md p-8">
                            <h1 className="text-2xl font-bold mb-6 text-center">Instagram Content Planner</h1>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-1">Notion Integration Token</label>
                                    <input type="password" value={notionToken} onChange={(e) => setNotionToken(e.target.value)} placeholder="secret_..." className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pink-400"/>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-1">Database ID</label>
                                    <input type="text" value={databaseId} onChange={(e) => setDatabaseId(e.target.value)} placeholder="your-database-id" className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pink-400"/>
                                </div>

                                <button onClick={fetchPosts} disabled={!notionToken || !databaseId || loading} className="w-full bg-pink-500 text-white font-semibold py-2 rounded-lg hover:bg-pink-600 disabled:opacity-50">
                                    {loading ? 'Connecting...' : 'Connect to Notion'}
                                </button>

                                {error && <div className="text-red-600 text-sm mt-2">{error}</div>}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-white">
                    <div className="max-w-5xl mx-auto px-3 py-6">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-2xl font-semibold text-gray-800">Instagram Feed</h1>
                            <button
                                onClick={fetchPosts}
                                disabled={loading}
                                className="flex items-center gap-2 bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-md hover:bg-gray-200 transition disabled:opacity-50"
                            >
                                <svg className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Refresh
                            </button>
                        </div>

                        {posts.length === 0 ? (
                            <div className="text-center text-gray-500 py-12">No posts found</div>
                        ) : (
                            <div className="grid grid-cols-3 gap-1">
                                {posts.map((post) => (
                                    <div key={post.id} className="relative group aspect-square bg-gray-100 overflow-hidden">
                                        {post.imageUrl ? (
                                            <img src={post.imageUrl} alt={post.name} className="w-full h-full object-cover group-hover:opacity-90 transition-all" />
                                        ) : (
                                            <div className="flex items-center justify-center w-full h-full">
                                                <svg className="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                            </div>
                                        )}
                                        <div className="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 flex items-end p-2 text-white text-xs transition">
                                            <span className="truncate">{formatDate(post.publishDate)}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<InstagramPlanner />, document.getElementById('root'));
    </script>
</body>
</html>
